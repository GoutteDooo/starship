pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
cls()
map(0,0,0,0)
spr(1,60,60)

function _init()
	p={x=60,y=90,speed=2}
	all_bullets={}
	create_stars()
	enemies={}
	explosions={}
	score=0
	state=0
	level=1
	wave={1,2,15,18,20}
	timer_wave=60
end

function _update60()
	if (state==0) update_game()
	if (state==1) update_gameover()
end

function _draw()
	if (state==0) draw_game()
	if (state==1) draw_gameover()
end

function update_game()
	update_player() 
	update_stars()
	update_bullets()
	update_enemies()
	update_explosions()
	update_wave()
end

function draw_game()
	cls()
	--stars
	for s in all(stars) do
		pset(s.x,s.y,s.col)
	end
	--enemies
	for e in all(enemies) do
		spr(16,e.x,e.y)
	end	
	--explosions
	draw_explosions()
	--vaisseau
	spr(1,p.x,p.y)
	--bullets
	for b in all(all_bullets) do
		spr(2,b.x,b.y-6)
	end
	--score
	print(score,2,2,10)
	--level
	print("lv ",108,2,10)
	print(level,120,2,10)
	draw_wave()
	--test
	print(wave[level],80,80)
end


-->8
--bullets

function shoot()
 new_bullet={
 	x=p.x,
 	y=p.y+6,
 	speed=6
 }
 add(all_bullets, new_bullet)
 sfx(0)
end

function update_bullets()
	for b in all(all_bullets) do
		b.y-=b.speed
		if (b.y<-8) del(all_bullets,b)
 end
end
-->8
--stars

function create_stars()
	stars={}
	for i=1,20 do
	new_star={
		x=rnd(128),
		y=rnd(128),
		col=rnd(9,10,14,15),
		speed=rnd(1)+0.5
	}
	add(stars,new_star)
	end
	for i=1,8 do
	new_star={
		x=rnd(128),
		y=rnd(128),
		col=1,
		speed=rnd()+0.2
	}
	add(stars,new_star)
	end
end

function update_stars()
	for s in all(stars) do
		s.y+=s.speed
		if s.y>128 then
		 s.y = 0
		 s.x = rnd(128)
		end
	end
end
-->8
--enemies

function spawn_enemies(amount)
	gap=(128-8*amount)/(amount+1)
 for i=1,amount do
	 new_enemy={
			x=gap*i+8*i-1,
			y=-8,
			hp=30,
			speed=0.3
			}
			add(enemies,new_enemy)
 end
end

function update_enemies()
	--spawn
	if #enemies==0 then
		if wave[level] < 7 then
			spawn_enemies(wave[level])
		else
		 spawn_enemies(ceil(rnd(4)+3))
		end
	end
	for e in all(enemies) do
		e.y+=e.speed
		if e.y>128 then
			kill_enemy(e)
		end
		--collisions
		for b in all(all_bullets) do
			if collision(e,b) then
				del(all_bullets,b)
				e.hp-=1
				create_explosion(b.x+4,b.y+2)
				if e.hp<=0 then
					sfx(2)
				 kill_enemy(e)
				 score+=10
				end
			end
		end
	end
end

function kill_enemy(e)
	del(enemies,e)
	wave[level] -=1
end
-->8
--collisions
function collision(a,b)
	return not 
	(a.x>b.x+8
	or a.y>b.y+8
	or a.x+8<b.x
	or a.y+8<b.y)
end
-->8
--explosions
function create_explosion(_x,_y)
	add(explosions,
	{x=_x,
	 y=_y,
	 timer=0})
	 sfx(1)
end

function update_explosions()
	for e in all(explosions) do
		e.timer += 1
		if (e.timer==13) del(explosions,e)
	end
end

function draw_explosions()
	for e in all(explosions) do
		circ(
		e.x,
		e.y,
		e.timer/3,
		8+e.timer%3)
	end
end
-->8
--player

function update_player()
	if (btn(➡️)) p.x+=p.speed
	if (btn(⬅️)) p.x-=p.speed
	if (btn(⬆️)) p.y-=p.speed
	if (btn(⬇️)) p.y+=p.speed-1
	if (btn(❎)) shoot()
	for e in all(enemies) do
		if collision(e,p) then
			state=1
		end
	end
end
-->8
--gameover

function update_gameover()
	if (btn(🅾️)) _init()
end

function draw_gameover()
	cls(13)
	rectfill(20,40,110,110,9)
	print("game over!",50,50,7)
	print("score:",50,58,7)
	print(score,50,66,13)
	print("press c to continue",28,100,7)
end
-->8
--waves

function draw_wave()
	if wave[level] <= 0 then
		print("wave",60,60)
		print(level+1,80,60)
		enemies={}
	end
end

function update_wave()
	if wave[level] <= 0 then
		timer_wave -=1
		if timer_wave <= 0 then
			timer_wave = 60
			level +=1
		end
	end
end
__gfx__
1111111100000000b000000b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1511115100d00d00b000000b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
15111111e040040eb000000b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111804c7408b000000b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111864cc468b000000b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111151186555568b000000b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1511111156666665b000000b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
111111110d0dd0d0b000000b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
02020200000010000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00333000010110100001100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
03333300010330101103301100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ee333ee0003bb300003bb300000cc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
e03330e003bbbb3003bbbb30000cc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0803080003bbbb3003bbbb3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000003bb300003bb30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000080220800802208000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000100003b14537145311452914523145201551d15518155121550815501155011050210501106011050110501105011050110601105011050110601106011060210502100021050210402106021000210002100
0002000026620336203e6201a6200c61001620006100161000610006103c6003d6003d6003360020600226001a6001660014600106000d6000b60008600066000460003600026000260001600006000060000600
00060000006200262005620146202c62035630306302b630286303463030630336302c63023630146400d6400b640096400764005640046400364002640026400164000640006400064000640006400063001630
000400003900035000300002d000260001e00016000110000c0000a00009000080000600006000050000400004000030000300002000020000200001000000000000000000000000000000000008000080000800
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0020000018a5000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
